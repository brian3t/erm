/* vim: set tabstop=4 softtabstop=4 shiftwidth=4 noexpandtab: *//**
 * Backbone-relational.js 0.10.0
 * (c) 2011-2014 Paul Uithol and contributors (https://github.com/PaulUithol/Backbone-relational/graphs/contributors)
 *
 * Backbone-relational may be freely distributed under the MIT license; see the accompanying LICENSE.txt.
 * For details and documentation: https://github.com/PaulUithol/Backbone-relational.
 * Depends on Backbone (and thus on Underscore as well): https://github.com/documentcloud/backbone.
 *
 * Example:
 *
	Zoo = Backbone.RelationalModel.extend({
		relations: [ {
			type: Backbone.HasMany,
			key: 'animals',
			relatedModel: 'Animal',
			reverseRelation: {
				key: 'livesIn',
				includeInJSON: 'id'
				// 'relatedModel' is automatically set to 'Zoo'; the 'relationType' to 'HasOne'.
			}
		} ],

		toString: function() {
			return this.get( 'name' );
		}
	});

	Animal = Backbone.RelationalModel.extend({
		toString: function() {
			return this.get( 'species' );
		}
	});

	// Creating the zoo will give it a collection with one animal in it: the monkey.
	// The animal created after that has a relation `livesIn` that points to the zoo it's currently associated with.
	// If you instantiate (or fetch) the zebra later, it will automatically be added.

	var zoo = new Zoo({
		name: 'Artis',
		animals: [ { id: 'monkey-1', species: 'Chimp' }, 'lion-1', 'zebra-1' ]
	});

	var lion = new Animal( { id: 'lion-1', species: 'Lion' } ),
		monkey = zoo.get( 'animals' ).first(),
		sameZoo = lion.get( 'livesIn' );
 */(function(e,t){typeof define=="function"&&define.amd?define(["exports","backbone","underscore"],t):typeof exports!="undefined"?t(exports,require("backbone"),require("underscore")):t(e,e.Backbone,e._)})(this,function(e,t,n){"use strict";t.Relational={showWarnings:!0},t.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(this._permitsUsed===0)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},t.BlockingQueue=function(){this._queue=[]},n.extend(t.BlockingQueue.prototype,t.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){var e=this._queue;this._queue=[];while(e&&e.length)e.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),t.Relational.eventQueue=new t.BlockingQueue,t.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[e]},n.extend(t.Store.prototype,t.Events,{initializeRelation:function(e,r,i){var s=n.isString(r.type)?t[r.type]||this.getObjectByName(r.type):r.type;if(s&&s.prototype instanceof t.Relation)var o=new s(e,r,i);else t.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",r)},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=n.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){n.find(this._subModels,function(t){return n.filter(t.subModels||[],function(n,r){var i=this.getObjectByName(n);if(e===i)return t.superModelType._subModels[r]=e,e._superModel=t.superModelType,e._subModelTypeValue=r,e._subModelTypeAttribute=t.superModelType.prototype.subModelTypeAttribute,!0},this).length},this)},addReverseRelation:function(e){var t=n.any(this._reverseRelations,function(t){return n.all(e||[],function(e,n){return e===t[n]})});!t&&e.model&&e.type&&(this._reverseRelations.push(e),this._addRelation(e.model,e),this.retroFitRelation(e))},addOrphanRelation:function(e){var t=n.any(this._orphanRelations,function(t){return n.all(e||[],function(e,n){return e===t[n]})});!t&&e.model&&e.type&&this._orphanRelations.push(e)},processOrphanRelations:function(){n.each(this._orphanRelations.slice(0),function(e){var r=t.Relational.store.getObjectByName(e.relatedModel);r&&(this.initializeRelation(null,e),this._orphanRelations=n.without(this._orphanRelations,e))},this)},_addRelation:function(e,t){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(t),n.each(e._subModels||[],function(e){this._addRelation(e,t)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,!1);t&&t.each(function(t){if(!(t instanceof e.model))return;var n=new e.type(t,e)},this)},getCollection:function(e,r){e instanceof t.RelationalModel&&(e=e.constructor);var i=e;while(i._superModel)i=i._superModel;var s=n.find(this._collections,function(e){return e.model===i});return!s&&r!==!1&&(s=this._createCollection(i)),s},getObjectByName:function(e){var t=e.split("."),r=null;return n.find(this._modelScopes,function(e){r=n.reduce(t||[],function(e,t){return e?e[t]:undefined},e);if(r&&r!==e)return!0},this),r},_createCollection:function(e){var n;return e instanceof t.RelationalModel&&(e=e.constructor),e.prototype instanceof t.RelationalModel&&(n=new t.Collection,n.model=e,this._collections.push(n)),n},resolveIdForItem:function(e,r){var i=n.isString(r)||n.isNumber(r)?r:null;return i===null&&(r instanceof t.RelationalModel?i=r.id:n.isObject(r)&&(i=r[e.prototype.idAttribute])),!i&&i!==0&&(i=null),i},find:function(e,t){var n=this.resolveIdForItem(e,t),r=this.getCollection(e);if(r){var i=r.get(n);if(i instanceof e)return i}return null},register:function(e){var t=this.getCollection(e);if(t){var n=e.collection;t.add(e),e.collection=n}},checkId:function(e,n){var r=this.getCollection(e),i=r&&r.get(n);if(i&&e!==i)throw t.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",i,e),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(e){var t=this.getCollection(e);t.contains(e)||this.register(e),t._onModelEvent("change:"+e.idAttribute,e,t),e.trigger("relational:change:id",e,t)},unregister:function(e){var r,i;e instanceof t.Model?(r=this.getCollection(e),i=[e]):e instanceof t.Collection?(r=this.getCollection(e.model),i=n.clone(e.models)):(r=this.getCollection(e),i=n.clone(r.models)),n.each(i,function(e){this.stopListening(e),n.invoke(e.getRelations(),"stopListening")},this),n.contains(this._collections,e)?r.reset([]):n.each(i,function(e){r.get(e)?r.remove(e):r.trigger("relational:remove",e,r)},this)},reset:function(){this.stopListening(),n.each(this._collections,function(e){this.unregister(e)},this),this._collections=[],this._subModels=[],this._modelScopes=[e]}}),t.Relational.store=new t.Store,t.Relation=function(e,r,i){this.instance=e,r=n.isObject(r)?r:{},this.reverseRelation=n.defaults(r.reverseRelation||{},this.options.reverseRelation),this.options=n.defaults(r,this.options,t.Relation.prototype.options),this.reverseRelation.type=n.isString(this.reverseRelation.type)?t[this.reverseRelation.type]||t.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,n.isUndefined(this.relatedModel)&&(this.relatedModel=this.model),n.isFunction(this.relatedModel)&&!(this.relatedModel.prototype instanceof t.RelationalModel)&&(this.relatedModel=n.result(this,"relatedModel")),n.isString(this.relatedModel)&&(this.relatedModel=t.Relational.store.getObjectByName(this.relatedModel));if(!this.checkPreconditions())return;!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&t.Relational.store.addReverseRelation(n.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation));if(e){var s=this.keySource;s!==this.key&&n.isObject(this.instance.get(this.key))&&(s=this.key),this.setKeyContents(this.instance.get(s)),this.relatedCollection=t.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(i),this.options.autoFetch&&this.instance.getAsync(this.key,n.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},t.Relation.extend=t.Model.extend,n.extend(t.Relation.prototype,t.Events,t.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,r=this.key,i=this.model,s=this.relatedModel,o=t.Relational.showWarnings&&typeof console!="undefined";if(!i||!r||!s)return o&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,i,r,s),!1;if(i.prototype instanceof t.RelationalModel){if(s.prototype instanceof t.RelationalModel){if(this instanceof t.HasMany&&this.reverseRelation.type===t.HasMany)return o&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&n.keys(e._relations).length){var u=n.find(e._relations,function(e){return e.key===r},this);if(u)return o&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,r,e,u),!1}return!0}return o&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,s),!1}return o&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e),!1},setRelated:function(e){this.related=e,this.instance.attributes[this.key]=e},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){var t=[],r=n.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e],i=null,s=null;for(var o=0;o<(r||[]).length;o++){i=r[o].getRelations()||[];for(var u=0;u<i.length;u++)s=i[u],this._isReverseRelation(s)&&t.push(s)}return t},destroy:function(){this.stopListening(),this instanceof t.HasOne?this.setRelated(null):this instanceof t.HasMany&&this.setRelated(this._prepareCollection()),n.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),t.HasOne=t.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var t=this.findRelated(e);this.setRelated(t),n.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var t=null;e=n.defaults({parse:this.options.parse},e);if(this.keyContents instanceof this.relatedModel)t=this.keyContents;else if(this.keyContents||this.keyContents===0){var r=n.defaults({create:this.options.createModels},e);t=this.relatedModel.findOrCreate(this.keyContents,r)}return t&&(this.keyId=null),t},setKeyContents:function(e){this.keyContents=e,this.keyId=t.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,r,i){if(this.isLocked())return;this.acquire(),i=i?n.clone(i):{};var s=n.isUndefined(i.__related),o=s?this.related:i.__related;if(s){this.setKeyContents(r);var u=this.findRelated(i);this.setRelated(u)}o&&this.related!==o&&n.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,i)},this),n.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);if(!i.silent&&this.related!==o){var a=this;this.changed=!0,t.Relational.eventQueue.add(function(){a.instance.trigger("change:"+a.key,a.instance,a.related,i,!0),a.changed=!1})}this.release()},tryAddRelated:function(e,t,n){(this.keyId||this.keyId===0)&&e.id===this.keyId&&(this.addRelated(e,n),this.keyId=null)},addRelated:function(e,t){var r=this;e.queue(function(){if(e!==r.related){var i=r.related||null;r.setRelated(e),r.onChange(r.instance,e,n.defaults({__related:i},t))}})},removeRelated:function(e,t,r){if(!this.related)return;if(e===this.related){var i=this.related||null;this.setRelated(null),this.onChange(this.instance,e,n.defaults({__related:i},r))}}}),t.HasMany=t.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:t.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,n.isFunction(this.collectionType)&&this.collectionType!==t.Collection&&!(this.collectionType.prototype instanceof t.Collection)&&(this.collectionType=n.result(this,"collectionType")),n.isString(this.collectionType)&&(this.collectionType=t.Relational.store.getObjectByName(this.collectionType));if(!(this.collectionType===t.Collection||this.collectionType.prototype instanceof t.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var r=this.findRelated(e);this.setRelated(r)},_prepareCollection:function(e){this.related&&this.stopListening(this.related);if(!e||!(e instanceof t.Collection)){var r=n.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,r)}e.model=this.relatedModel;if(this.options.collectionKey){var i=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[i]&&e[i]!==this.instance?t.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,i,this.options.collectionKey):i&&(e[i]=this.instance)}return this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset),e},findRelated:function(e){var r=null;e=n.defaults({parse:this.options.parse},e);if(this.keyContents instanceof t.Collection)this._prepareCollection(this.keyContents),r=this.keyContents;else{var i=[];n.each(this.keyContents,function(t){var r=null;t instanceof this.relatedModel?r=t:r=n.isObject(t)&&e.parse&&this.relatedModel.prototype.parse?this.relatedModel.prototype.parse(n.clone(t),e):t,r&&i.push(r)},this),this.related instanceof t.Collection?r=this.related:r=this._prepareCollection(),r.set(i,n.defaults({parse:!1},e))}return this.keyIds=n.difference(this.keyIds,n.pluck(r.models,"id")),r},setKeyContents:function(e){this.keyContents=e instanceof t.Collection?e:null,this.keyIds=[],!this.keyContents&&(e||e===0)&&(this.keyContents=n.isArray(e)?e:[e],n.each(this.keyContents,function(e){var n=t.Relational.store.resolveIdForItem(this.relatedModel,e);(n||n===0)&&this.keyIds.push(n)},this))},onChange:function(e,r,i){i=i?n.clone(i):{},this.setKeyContents(r),this.changed=!1;var s=this.findRelated(i);this.setRelated(s);if(!i.silent){var o=this;t.Relational.eventQueue.add(function(){o.changed&&(o.instance.trigger("change:"+o.key,o.instance,o.related,i,!0),o.changed=!1)})}},handleAddition:function(e,r,i){i=i?n.clone(i):{},this.changed=!0,n.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var s=this;!i.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("add:"+s.key,e,s.related,i)})},handleRemoval:function(e,r,i){i=i?n.clone(i):{},this.changed=!0,n.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,i)},this);var s=this;!i.silent&&t.Relational.eventQueue.add(function(){s.instance.trigger("remove:"+s.key,e,s.related,i)})},handleReset:function(e,r){var i=this;r=r?n.clone(r):{},!r.silent&&t.Relational.eventQueue.add(function(){i.instance.trigger("reset:"+i.key,i.related,r)})},tryAddRelated:function(e,t,r){var i=n.contains(this.keyIds,e.id);i&&(this.addRelated(e,r),this.keyIds=n.without(this.keyIds,e.id))},addRelated:function(e,t){var r=this;e.queue(function(){r.related&&!r.related.get(e)&&r.related.add(e,n.defaults({parse:!1},t))})},removeRelated:function(e,t,n){this.related.get(e)&&this.related.remove(e,n)}}),t.RelationalModel=t.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,r){if(r&&r.collection){var i=this,s=this.collection=r.collection;delete r.collection,this._deferProcessing=!0;var o=function(e){e===i&&(i._deferProcessing=!1,i.processQueue(),s.off("relational:add",o))};s.on("relational:add",o),n.defer(function(){o(i)})}t.Relational.store.processOrphanRelations(),t.Relational.store.listenTo(this,"relational:unregister",t.Relational.store.unregister),this._queue=new t.BlockingQueue,this._queue.block(),t.Relational.eventQueue.block();try{t.Model.apply(this,arguments)}finally{t.Relational.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&e.indexOf("change")===0){var n=this,r=arguments;t.Relational.eventQueue.isBlocked()?t.Relational.eventQueue.add(function(){var i=!0;if(e==="change")i=n.hasChanged()||n._attributeChangeFired,n._attributeChangeFired=!1;else{var s=e.slice(7),o=n.getRelation(s);o?(i=r[4]===!0,i?n.changed[s]=r[2]:o.changed||delete n.changed[s]):i&&(n._attributeChangeFired=!0)}i&&t.Model.prototype.trigger.apply(n,r)}):t.Model.prototype.trigger.apply(n,r)}else e==="destroy"?(t.Model.prototype.trigger.apply(this,arguments),t.Relational.store.unregister(this)):t.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(e){this.acquire(),this._relations={},n.each(this.relations||[],function(n){t.Relational.store.initializeRelation(this,n,e)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(e,t){this._isInitialized&&!this.isLocked()&&n.each(this._relations,function(n){if(!e||n.keySource in e||n.key in e){var r=this.attributes[n.keySource]||this.attributes[n.key],i=e&&(e[n.keySource]||e[n.key]);(n.related!==r||r===null&&i===null)&&this.trigger("relational:change:"+n.key,this,r,t||{})}n.keySource!==n.key&&delete this.attributes[n.keySource]},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return this._relations[e]},getRelations:function(){return n.values(this._relations)},getIdsToFetch:function(e,r){var i=e instanceof t.Relation?e:this.getRelation(e),s=i?i.keyIds&&i.keyIds.slice(0)||(i.keyId||i.keyId===0?[i.keyId]:[]):[];if(r){var o=i.related&&(i.related.models||[i.related]);n.each(o,function(e){(e.id||e.id===0)&&s.push(e.id)})}return s},getAsync:function(e,r){r=n.extend({add:!0,remove:!1,refresh:!1},r);var i=this,s=[],o=this.getRelation(e),u=o&&this.getIdsToFetch(o,r.refresh),a=o.related instanceof t.Collection?o.related:o.relatedCollection;if(u&&u.length){var f=[],l=[],c,h=function(){f=n.map(u,function(e){var t=o.relatedModel.findModel(e);if(!t){var n={};n[o.relatedModel.prototype.idAttribute]=e,t=o.relatedModel.findOrCreate(n,r),l.push(t)}return t},this)};if(a instanceof t.Collection&&n.isFunction(a.url)){var p=a.url();c=a.url(u),c===p&&(h(),c=a.url(f),c===p&&(c=null))}if(c){var d=n.defaults({error:function(){n.each(l,function(e){e.trigger("destroy",e,e.collection,r)}),r.error&&r.error.apply(f,arguments)},url:c},r);s=[a.fetch(d)]}else f.length||h(),s=n.map(f,function(e){var t=n.defaults({error:function(){n.contains(l,e)&&e.trigger("destroy",e,e.collection,r),r.error&&r.error.apply(f,arguments)}},r);return e.fetch(t)},this)}return this.deferArray(s).then(function(){return t.Model.prototype.get.call(i,e)})},deferArray:function(e){return t.$.when.apply(null,e)},set:function(e,r,i){t.Relational.eventQueue.block();var s,o;n.isObject(e)||e==null?(s=e,i=r):(s={},s[e]=r);try{var u=this.id,a=s&&this.idAttribute in s&&s[this.idAttribute];t.Relational.store.checkId(this,a),o=t.Model.prototype.set.apply(this,arguments),!this._isInitialized&&!this.isLocked()?(this.constructor.initializeModelHierarchy(),(a||a===0)&&t.Relational.store.register(this),this.initializeRelations(i)):a&&a!==u&&t.Relational.store.update(this),s&&this.updateRelations(s,i)}finally{t.Relational.eventQueue.unblock()}return o},clone:function(){var e=n.clone(this.attributes);return n.isUndefined(e[this.idAttribute])||(e[this.idAttribute]=null),n.each(this.getRelations(),function(t){delete e[t.key]}),new this.constructor(e)},toJSON:function(e){if(this.isLocked())return this.id;this.acquire();var r=t.Model.prototype.toJSON.call(this,e);return this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in r)&&(r[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),n.each(this._relations,function(i){var s=r[i.key],o=i.options.includeInJSON,u=null;o===!0?s&&n.isFunction(s.toJSON)&&(u=s.toJSON(e)):n.isString(o)?(s instanceof t.Collection?u=s.pluck(o):s instanceof t.Model&&(u=s.get(o)),o===i.relatedModel.prototype.idAttribute&&(i instanceof t.HasMany?u=u.concat(i.keyIds):i instanceof t.HasOne&&(u=u||i.keyId,!u&&!n.isObject(i.keyContents)&&(u=i.keyContents||null)))):n.isArray(o)?s instanceof t.Collection?(u=[],s.each(function(e){var t={};n.each(o,function(n){t[n]=e.get(n)}),u.push(t)})):s instanceof t.Model&&(u={},n.each(o,function(e){u[e]=s.get(e)})):delete r[i.key],u===null&&e&&e.wait&&(u=s),o&&(r[i.keyDestination]=u),i.keyDestination!==i.key&&delete r[i.key]}),this.release(),r}},{setup:function(e){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?t.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,n.each(this.prototype.relations||[],function(e){e.model||(e.model=this);if(e.reverseRelation&&e.model===this){var r=!0;if(n.isString(e.relatedModel)){var i=t.Relational.store.getObjectByName(e.relatedModel);r=i&&i.prototype instanceof t.RelationalModel}r?t.Relational.store.initializeRelation(null,e):n.isString(e.relatedModel)&&t.Relational.store.addOrphanRelation(e)}},this),this},build:function(e,t){this.initializeModelHierarchy();var n=this._findSubModelType(this,e)||this;return new n(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var n=t[e.prototype.subModelTypeAttribute],r=e._subModels[n];if(r)return r;for(n in e._subModels){r=this._findSubModelType(e._subModels[n],t);if(r)return r}}return null},initializeModelHierarchy:function(){this.inheritRelations();if(this.prototype.subModelTypes){var e=n.keys(this._subModels),r=n.omit(this.prototype.subModelTypes,e);n.each(r,function(e){var n=t.Relational.store.getObjectByName(e);n&&n.initializeModelHierarchy()})}},inheritRelations:function(){if(!n.isUndefined(this._superModel)&&!n.isNull(this._superModel))return;t.Relational.store.setupSuperModel(this);if(this._superModel){this._superModel.inheritRelations();if(this._superModel.prototype.relations){var e=n.filter(this._superModel.prototype.relations||[],function(e){return!n.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(e,t){t||(t={});var r=n.isObject(e)&&t.parse&&this.prototype.parse?this.prototype.parse(n.clone(e),t):e,i=this.findModel(r);return n.isObject(e)&&(i&&t.merge!==!1?(delete t.collection,delete t.url,i.set(r,t)):!i&&t.create!==!1&&(i=this.build(r,n.defaults({parse:!1},t)))),i},find:function(e,t){return t||(t={}),t.create=!1,this.findOrCreate(e,t)},findModel:function(e){return t.Relational.store.find(this,e)}}),n.extend(t.RelationalModel.prototype,t.Semaphore),t.Collection.prototype.__prepareModel=t.Collection.prototype._prepareModel,t.Collection.prototype._prepareModel=function(e,r){var i;return e instanceof t.Model?(e.collection||(e.collection=this),i=e):(r=r?n.clone(r):{},r.collection=this,typeof this.model.findOrCreate!="undefined"?i=this.model.findOrCreate(e,r):i=new this.model(e,r),i&&i.validationError&&(this.trigger("invalid",this,e,r),i=!1)),i};var r=t.Collection.prototype.__set=t.Collection.prototype.set;t.Collection.prototype.set=function(e,i){if(this.model.prototype instanceof t.RelationalModel){i&&i.parse&&(e=this.parse(e,i));var s=!n.isArray(e),o=[],u=[],a=null;e=s?e?[e]:[]:n.clone(e);for(var f=0;f<e.length;f++)a=e[f],a instanceof t.Model||(a=t.Collection.prototype._prepareModel.call(this,a,i)),a&&(u.push(a),!this.get(a)&&!this.get(a.cid)?o.push(a):a.id!==null&&a.id!==undefined&&(this._byId[a.id]=a));u=s?u.length?u[0]:null:u;var l=r.call(this,u,n.defaults({merge:!1,parse:!1},i));for(f=0;f<o.length;f++)a=o[f],(this.get(a)||this.get(a.cid))&&this.trigger("relational:add",a,this,i);return l}return r.call(this,e,i)};var i=t.Collection.prototype.___removeModels=t.Collection.prototype._removeModels;t.Collection.prototype._removeModels=function(e,r){if(this.model.prototype instanceof t.RelationalModel){var s=[];n.each(e,function(e){e=this.get(e)||e&&this.get(e.cid),e&&s.push(e)},this);var o=i.call(this,s,r);return n.each(s,function(e){this.trigger("relational:remove",e,this,r)},this),o}return i.call(this,e,r)};var s=t.Collection.prototype.__reset=t.Collection.prototype.reset;t.Collection.prototype.reset=function(e,r){r=n.extend({merge:!0},r);var i=s.call(this,e,r);return this.model.prototype instanceof t.RelationalModel&&this.trigger("relational:reset",this,r),i};var o=t.Collection.prototype.__sort=t.Collection.prototype.sort;t.Collection.prototype.sort=function(e){var n=o.call(this,e);return this.model.prototype instanceof t.RelationalModel&&this.trigger("relational:reset",this,e),n};var u=t.Collection.prototype.__trigger=t.Collection.prototype.trigger;t.Collection.prototype.trigger=function(e){if(this.model.prototype instanceof t.RelationalModel){if(e==="add"||e==="remove"||e==="reset"||e==="sort"){var r=this,i=arguments;n.isObject(i[3])&&(i=n.toArray(i),i[3]=n.clone(i[3])),t.Relational.eventQueue.add(function(){u.apply(r,i)})}else u.apply(this,arguments);return this}return u.apply(this,arguments)},t.RelationalModel.extend=function(e,n){var r=t.Model.extend.call(this,e,n);return r.setup(this),r}});